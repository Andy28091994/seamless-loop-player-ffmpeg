<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seamless Loop Player — Desktop (FFmpeg)</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:18px;display:flex;gap:12px;flex-direction:column;align-items:center}
  .controls{display:flex;gap:8px;align-items:center}
  button{padding:8px 12px;border-radius:8px;background:#0b74ff;color:#fff;border:0}
  .player{width:100%;max-width:960px;border-radius:10px;background:#000;overflow:hidden;padding-top:56.25%;position:relative}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#000}
  input[type=range]{width:200px}
  .notice{color:#555;font-size:13px}
</style>
</head>
<body>
  <h2>Seamless Loop Player — FFmpeg edition</h2>
  <div class="notice">This build will transcode unsupported videos (HEVC, MKV, AV1, etc.) to a compatible MP4 automatically using FFmpeg (bundled). Use "Open & Convert" for best compatibility.</div>

  <div class="controls">
    <button id="open">Open & Convert</button>
    <button id="openRaw">Open (no convert)</button>
    <button id="export" disabled>Export Loop (2 min)</button>
    <label>Crossfade <input id="xfade" type="range" min="0" max="3" step="0.1" value="0.8"></label>
    <label>Preload <input id="preload" type="range" min="0.1" max="3" step="0.1" value="0.9"></label>
  </div>

  <div class="player">
    <video id="v1" playsinline muted></video>
    <video id="v2" playsinline muted style="opacity:0"></video>
  </div>

  <div class="controls">
    <button id="play" disabled>Play</button>
    <button id="pause" disabled>Pause</button>
    <span id="status" class="notice"></span>
  </div>

<script>
const openBtn = document.getElementById('open');
const openRawBtn = document.getElementById('openRaw');
const exportBtn = document.getElementById('export');
const playBtn = document.getElementById('play');
const pauseBtn = document.getElementById('pause');
const status = document.getElementById('status');
const xfade = document.getElementById('xfade');
const preload = document.getElementById('preload');
const v1 = document.getElementById('v1');
const v2 = document.getElementById('v2');

let active = v1, passive = v2;
let isLoaded=false, isPlaying=false, currentSrc=null;

openBtn.addEventListener('click', async ()=>{
  status.textContent = 'Select file — will transcode if needed...';
  const res = await window.electronAPI.openAndConvert();
  if (!res) { status.textContent = 'No file selected.'; return; }
  loadSrc(res);
});

openRawBtn.addEventListener('click', async ()=>{
  status.textContent = 'Select file (no convert).';
  const res = await window.electronAPI.openFile();
  if (!res) { status.textContent = 'No file.'; return; }
  loadSrc(res);
});

exportBtn.addEventListener('click', async ()=>{
  if(!currentSrc){ alert('Load a video first'); return; }
  status.textContent = 'Exporting 2-minute loop using FFmpeg...';
  exportBtn.disabled = true;
  const out = await window.electronAPI.exportLoop(currentSrc, 120); // 120 seconds
  if(out && out.ok){
    status.textContent = 'Exported: ' + out.path;
  } else {
    status.textContent = 'Export failed.';
  }
  exportBtn.disabled = false;
});

function loadSrc(path){
  currentSrc = path;
  isLoaded=false;
  active.src = path;
  passive.src = path;
  Promise.all([
    new Promise(res=> active.onloadedmetadata = ()=>res()),
    new Promise(res=> passive.onloadedmetadata = ()=>res())
  ]).then(()=>{
    isLoaded=true;
    playBtn.disabled=false; pauseBtn.disabled=false; exportBtn.disabled=false;
    status.textContent = 'Loaded — set crossfade & press Play.';
    active.currentTime = 0; passive.currentTime = 0;
    active.style.opacity = 1; passive.style.opacity = 0;
  }).catch(e=>{ status.textContent='Failed to load metadata.'; console.error(e); });
}

function startCrossfade(){
  passive.dataset.pending = '1';
  passive.currentTime = 0;
  passive.volume = 0;
  passive.style.opacity = 0;
  const crossfade = parseFloat(xfade.value);
  const steps = Math.max(10, Math.round(crossfade*30));
  const interval = (crossfade/steps)*1000;
  passive.play().catch(()=>{});
  let i=0;
  const timer = setInterval(()=>{
    i++; const t = i/steps;
    passive.style.opacity = t; active.style.opacity = 1-t;
    if(i>=steps){ clearInterval(timer); active.pause(); active.style.opacity=0; active.dataset.pending=''; passive.dataset.pending=''; const old=active; active=passive; passive=old; }
  }, interval);
}

function attachTimeupdate(video){ video.addEventListener('timeupdate', onTimeupdate); }
function onTimeupdate(e){
  if(!isPlaying || !isLoaded) return;
  const dur = e.target.duration; if(!isFinite(dur)) return;
  const remaining = dur - e.target.currentTime;
  if(e.target === active && remaining <= parseFloat(preload.value) && !passive.dataset.pending){
    startCrossfade();
  }
}

playBtn.addEventListener('click', async ()=>{ if(!isLoaded){ alert('Load file first'); return; } try{ await active.play(); isPlaying=true; }catch(e){ console.warn(e); } });
pauseBtn.addEventListener('click', ()=>{ isPlaying=false; active.pause(); passive.pause(); });

window.addEventListener('keydown',(e)=>{ if(e.code==='Space'){ e.preventDefault(); if(isPlaying) pauseBtn.click(); else playBtn.click(); } });

</script>
</body>
</html>